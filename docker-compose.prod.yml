version: '3.8'

services:
  # FastAPI 백엔드 (프로덕션)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: mlops-backend-prod
    environment:
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_SCHEMA=${DATABASE_SCHEMA}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./backend/logs:/app/logs
    networks:
      - mlops-prod-network
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Nginx (프로덕션)
  nginx:
    image: nginx:alpine
    container_name: mlops-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/nginx/ssl:/etc/nginx/ssl
      - nginx_logs:/var/log/nginx
    depends_on:
      - backend
    networks:
      - mlops-prod-network
    restart: unless-stopped

  # MLflow (프로덕션)
  mlflow:
    image: python:3.10-slim
    container_name: mlops-mlflow-prod
    environment:
      - MLFLOW_BACKEND_STORE_URI=${MLFLOW_BACKEND_STORE_URI}
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=${MLFLOW_DEFAULT_ARTIFACT_ROOT}
    volumes:
      - mlflow_artifacts:/mlflow/artifacts
    command: >
      bash -c "
        pip install mlflow psycopg2-binary &&
        mlflow server 
        --backend-store-uri ${MLFLOW_BACKEND_STORE_URI}
        --default-artifact-root ${MLFLOW_DEFAULT_ARTIFACT_ROOT}
        --host 0.0.0.0
        --port 5000
      "
    networks:
      - mlops-prod-network
    restart: unless-stopped

  # Prometheus (프로덕션)
  prometheus:
    image: prom/prometheus:latest
    container_name: mlops-prometheus-prod
    volumes:
      - ./monitoring/prometheus/prometheus.prod.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - mlops-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Grafana (프로덕션)
  grafana:
    image: grafana/grafana:latest
    container_name: mlops-grafana-prod
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - mlops-prod-network
    restart: unless-stopped

volumes:
  mlflow_artifacts:
  prometheus_data:
  grafana_data:
  nginx_logs:

networks:
  mlops-prod-network:
    driver: bridge