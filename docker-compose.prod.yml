version: '3.8'

services:
  # FastAPI 백엔드 (프로덕션)
  backend:
    image: mlops-platform-backend:prod
    container_name: mlops-backend-prod
    ports:
      - "9000:9000"
    env_file:
      - ./backend/.env
    environment:
      - DATABASE_HOST=${POSTGRES_HOST:-114.202.2.226}
      - DATABASE_PORT=${POSTGRES_PORT:-5433}
      - DATABASE_NAME=${POSTGRES_DB:-postgres}
      - DATABASE_SCHEMA=${DATABASE_SCHEMA:-mlops}
      - DATABASE_USER=${POSTGRES_USER:-postgres}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    volumes:
      - ./backend/logs:/app/logs
    networks:
      - mlops-prod-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 5s
      start_period: 40s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Airflow Webserver (프로덕션)
  airflow-webserver:
    image: apache/airflow:2.7.3
    container_name: mlops-airflow-webserver
    user: "${AIRFLOW_UID:-1000}:0"
    ports:
      - "8080:8080"
    environment:
      - AIRFLOW__CORE__EXECUTOR=SequentialExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////opt/airflow/airflow.db
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=true
      - AIRFLOW__CORE__LOAD_EXAMPLES=false
      - AIRFLOW__WEBSERVER__SECRET_KEY=${AIRFLOW__WEBSERVER__SECRET_KEY:-mlops-airflow-secret-2024}
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - airflow_db:/opt/airflow
    networks:
      - mlops-prod-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5
    command: >
      bash -c "
        airflow db migrate &&
        airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com 2>/dev/null || true &&
        airflow webserver --port 8080
      "

  # Airflow Scheduler (프로덕션)
  airflow-scheduler:
    image: apache/airflow:2.7.3
    container_name: mlops-airflow-scheduler
    user: "${AIRFLOW_UID:-1000}:0"
    environment:
      - AIRFLOW__CORE__EXECUTOR=SequentialExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////opt/airflow/airflow.db
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=true
      - AIRFLOW__CORE__LOAD_EXAMPLES=false
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - airflow_db:/opt/airflow
    depends_on:
      - airflow-webserver
    networks:
      - mlops-prod-network
    restart: unless-stopped
    command: scheduler

  # Nginx (프로덕션)
  nginx:
    image: nginx:alpine
    container_name: mlops-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/nginx/ssl:/etc/nginx/ssl
      - nginx_logs:/var/log/nginx
    depends_on:
      - backend
    networks:
      - mlops-prod-network
    restart: unless-stopped

  # MLflow (프로덕션)
  mlflow:
    image: python:3.10-slim
    container_name: mlops-mlflow-prod
    ports:
      - "5001:5000"
    environment:
      - MLFLOW_BACKEND_STORE_URI=sqlite:///mlflow/mlflow.db
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    volumes:
      - ./mlflow:/mlflow
      - ./mlflow/artifacts:/mlflow/artifacts
    command: >
      bash -c "
        pip install --no-cache-dir mlflow==2.17.2 psycopg2-binary &&
        mlflow server
        --backend-store-uri sqlite:///mlflow/mlflow.db
        --default-artifact-root /mlflow/artifacts
        --host 0.0.0.0
        --port 5000
      "
    networks:
      - mlops-prod-network
    restart: unless-stopped

  # Prometheus (프로덕션)
  prometheus:
    image: prom/prometheus:latest
    container_name: mlops-prometheus-prod
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.prod.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - mlops-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Grafana (프로덕션)
  grafana:
    image: grafana/grafana:latest
    container_name: mlops-grafana-prod
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin123}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - mlops-prod-network
    restart: unless-stopped

volumes:
  mlflow_artifacts:
  prometheus_data:
  grafana_data:
  nginx_logs:
  airflow_db:

networks:
  mlops-prod-network:
    driver: bridge